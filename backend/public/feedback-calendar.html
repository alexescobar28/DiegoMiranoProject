<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0"
    />
    <title>Document</title>
    <link
      rel="stylesheet"
      href="Css/feedback-calendar.css"
    />
  </head>
  <body>
    <div class="phone-container">
      <div class="screen">
        <div class="logo">
          <img
            src="./assets/images/logo.png"
            alt="Logo"
            class="logo-image"
          />
        </div>

        <h1 class="title">Calendario de expectativas</h1>

        <p class="subtitle">
          Marca tu fecha estimada de llegada y la fecha que llegó
        </p>

        <div class="date-section">
          <div class="date-group">
            <div class="date-label">fecha esperada</div>
            <input
              type="date"
              class="date-input"
              id="expectedDate"
              value="2025-06-28"
            />
          </div>
          <div class="date-group">
            <div class="date-label">fecha llegada</div>
            <input
              type="date"
              class="date-input"
              id="arrivalDate"
              value="2025-06-28"
            />
          </div>
        </div>

        <div
          class="message-box"
          id="messageBox"
        >
          <div
            class="message-text"
            id="messageText"
          >
            Nos alegra saber que tu producto llegó a tiempo
          </div>
        </div>

        <button
          class="button"
          onclick="checkDates()"
        >
          Siguiente
        </button>
      </div>
    </div>

    <script>
      // Obtener boxId de la URL
      function obtenerBoxId() {
        const urlParams = new URLSearchParams(window.location.search);
        return urlParams.get('boxId') || 'ZBX90234';
      }

      const boxId = obtenerBoxId();
      function updateMessage() {
        const expectedDate = document.getElementById('expectedDate').value;
        const arrivalDate = document.getElementById('arrivalDate').value;
        const messageBox = document.getElementById('messageBox');
        const messageText = document.getElementById('messageText');

        if (expectedDate && arrivalDate) {
          if (expectedDate === arrivalDate) {
            messageBox.classList.add('success');
            messageBox.classList.remove('error');
            messageText.textContent =
              'Nos alegra saber que tu producto llegó a tiempo';
          } else {
            messageBox.classList.remove('success');
            messageBox.classList.add('error');
            messageText.textContent =
              'Lo sentimos, estamos trabajando para que tu próxima experiencia sea perfecta';
          }
        }
      }
      // Función para enviar calendario al backend
      async function enviarCalendario(expectedDate, arrivalDate) {
        try {
          const response = await fetch(
            'https://diegomiranoproject.onrender.com/feedback/calendario',
            {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json',
              },
              body: JSON.stringify({
                boxId: boxId,
                fechaEsperada: expectedDate,
                fechaLlegada: arrivalDate,
              }),
            }
          );

          const data = await response.json();

          if (response.ok) {
            console.log('Calendario enviado exitosamente:', data);

            // Mostrar mensaje de éxito con información adicional
            const mensaje = data.resumen.llegadaATiempo
              ? '¡Gracias por confirmar que tu producto llegó a tiempo!'
              : `¡Gracias por tu feedback! Tu producto ${data.resumen.estado}`;

            alert(mensaje);

            // Redirigir a la página de agradecimiento
            window.location.href = `thanks.html?boxId=${boxId}`;
          } else {
            console.error('Error enviando calendario:', data);
            alert('Error al enviar el calendario. Por favor intenta de nuevo.');
          }
        } catch (error) {
          console.error('Error de conexión:', error);
          alert('Error de conexión. Por favor intenta de nuevo.');
        }
      }
      function checkDates() {
        const expectedDate = document.getElementById('expectedDate').value;
        const arrivalDate = document.getElementById('arrivalDate').value;

        if (!expectedDate || !arrivalDate) {
          alert('Por favor, selecciona ambas fechas');
          return;
        }
        // Validar que las fechas sean válidas
        const fechaEsperada = new Date(expectedDate);
        const fechaLlegada = new Date(arrivalDate);

        if (isNaN(fechaEsperada.getTime()) || isNaN(fechaLlegada.getTime())) {
          alert('Por favor, selecciona fechas válidas');
          return;
        }
        updateMessage();

        enviarCalendario(fechaEsperada, fechaLlegada);
        window.location.href = 'thanks.html'; // Redirigir a la siguiente pantalla
      }
      // Función para obtener la fecha de hoy en formato YYYY-MM-DD
      function obtenerFechaHoy() {
        const hoy = new Date();
        return hoy.toISOString().split('T')[0];
      }

      // Función para obtener la fecha de hace una semana
      function obtenerFechaSemanaAnterior() {
        const fecha = new Date();
        fecha.setDate(fecha.getDate() - 7);
        return fecha.toISOString().split('T')[0];
      }
      // Event listeners para actualizar el mensaje cuando cambien las fechas
      document
        .getElementById('expectedDate')
        .addEventListener('change', updateMessage);
      document
        .getElementById('arrivalDate')
        .addEventListener('change', updateMessage);

      // Inicializar cuando se carga la página
      document.addEventListener('DOMContentLoaded', function () {
        // Establecer fechas por defecto si no hay valores guardados
        const expectedDateInput = document.getElementById('expectedDate');
        const arrivalDateInput = document.getElementById('arrivalDate');

        if (!expectedDateInput.value) {
          expectedDateInput.value = obtenerFechaSemanaAnterior();
        }

        if (!arrivalDateInput.value) {
          arrivalDateInput.value = obtenerFechaHoy();
        }

        // Cargar datos existentes si los hay
        cargarCalendarioExistente();

        // Actualizar mensaje inicial
        updateMessage();
      });
    </script>
  </body>
</html>
